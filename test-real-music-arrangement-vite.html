<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎵 Real Music Arrangement BC Test (Vite)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section h2 {
            margin-top: 0;
            color: #ffd700;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            padding-bottom: 10px;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .track-button {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }
        
        .collaboration-button {
            background: linear-gradient(45deg, #a8edea, #fed6e3);
            color: #333;
        }
        
        .audio-button {
            background: linear-gradient(45deg, #ffeaa7, #fab1a0);
            color: #333;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        input, select {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        
        .status {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .track-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .track-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .track-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .track-controls {
            display: flex;
            gap: 5px;
        }
        
        .small-button {
            padding: 5px 10px;
            font-size: 12px;
            min-width: auto;
        }
        
        .error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .success {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid rgba(0, 255, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .warning {
            background: rgba(255, 165, 0, 0.2);
            border: 1px solid rgba(255, 165, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .emoji {
            font-size: 1.2em;
            margin-right: 8px;
        }
        
        .instructions {
            background: rgba(0, 123, 255, 0.2);
            border: 1px solid rgba(0, 123, 255, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎵 Real Music Arrangement BC Test (Vite)</h1>
        
        <div class="instructions">
            <h3>📋 使用說明</h3>
            <p><strong>重要：</strong>這個頁面需要在 Vite 開發伺服器中運行才能正確載入 TypeScript 模組。</p>
            <ol>
                <li>在終端機中執行：<code>npm run dev</code></li>
                <li>在瀏覽器中訪問：<code>http://localhost:3001/test-real-music-arrangement-vite.html</code></li>
                <li>Vite 會自動編譯 TypeScript 並提供模組</li>
            </ol>
        </div>
        
        <div id="moduleStatus" class="section">
            <h2>📦 Module Loading Status</h2>
            <div id="loadingStatus">🔄 Loading music-arrangement module...</div>
        </div>
        
        <!-- Track Management Section -->
        <div class="section">
            <h2>🎛️ Track Management (Real BC)</h2>
            
            <div class="input-group">
                <input type="text" id="trackName" placeholder="軌道名稱" value="My Real Track">
                <select id="trackType">
                    <option value="audio">Audio Track</option>
                    <option value="instrument">MIDI/Instrument Track</option>
                    <option value="bus">Bus Track</option>
                </select>
                <input type="text" id="ownerId" placeholder="擁有者 ID" value="user123">
            </div>
            
            <div class="button-grid">
                <button onclick="createRealTrack()" class="track-button">
                    <span class="emoji">➕</span>創建真實軌道
                </button>
                <button onclick="getTrackInfo()" class="track-button">
                    <span class="emoji">📋</span>獲取軌道資訊
                </button>
                <button onclick="testRealAudio()" class="audio-button">
                    <span class="emoji">🎵</span>測試真實音頻
                </button>
                <button onclick="getRealSystemStats()" class="track-button">
                    <span class="emoji">📊</span>真實系統統計
                </button>
            </div>
            
            <div class="track-list" id="realTrackList">
                <!-- 真實軌道列表將在這裡顯示 -->
            </div>
        </div>
        
        <!-- MIDI Section -->
        <div class="section">
            <h2>🎹 MIDI Operations (Real BC)</h2>
            
            <div class="input-group">
                <input type="text" id="midiTrackId" placeholder="MIDI 軌道 ID">
                <input type="number" id="midiNote" placeholder="音符 (60=C4)" value="60" min="0" max="127">
                <input type="number" id="midiVelocity" placeholder="力度" value="100" min="0" max="127">
                <input type="number" id="midiStartTime" placeholder="開始時間" value="0" step="0.1">
                <input type="number" id="midiDuration" placeholder="持續時間" value="1" step="0.1">
            </div>
            
            <div class="button-grid">
                <button onclick="addMidiNote()" class="audio-button">
                    <span class="emoji">🎹</span>添加 MIDI 音符
                </button>
                <button onclick="quantizeMidi()" class="audio-button">
                    <span class="emoji">📐</span>量化 MIDI
                </button>
                <button onclick="transposeMidi()" class="audio-button">
                    <span class="emoji">🎵</span>移調 MIDI
                </button>
                <button onclick="getClipsInTrack()" class="track-button">
                    <span class="emoji">📋</span>獲取軌道片段
                </button>
            </div>
        </div>
        
        <!-- Audio Clips Section -->
        <div class="section">
            <h2>🎵 Audio Clips (Real BC)</h2>
            
            <div class="input-group">
                <input type="text" id="audioTrackId" placeholder="音頻軌道 ID">
                <input type="text" id="audioUrl" placeholder="音頻 URL" value="https://example.com/audio.mp3">
                <input type="number" id="audioStartTime" placeholder="開始時間" value="0" step="0.1">
                <input type="number" id="audioDuration" placeholder="持續時間" value="5" step="0.1">
            </div>
            
            <div class="button-grid">
                <button onclick="createAudioClip()" class="audio-button">
                    <span class="emoji">🎵</span>創建音頻片段
                </button>
                <button onclick="setAudioClipGain()" class="audio-button">
                    <span class="emoji">🎛️</span>設定音頻增益
                </button>
            </div>
        </div>
        
        <!-- System Status -->
        <div class="section">
            <h2>📊 System Status</h2>
            <button onclick="clearLog()" class="collaboration-button">
                <span class="emoji">🧹</span>清除日誌
            </button>
            <div class="status" id="status">
                <div>🎵 Initializing Real Music Arrangement BC...</div>
            </div>
        </div>
    </div>

    <script type="module">
        // 🎵 真正使用 Music Arrangement BC 模組 (通過 Vite)
        
        let musicArrangementService = null;
        let isModuleLoaded = false;
        let currentTrackId = null;
        
        // 嘗試載入真正的模組
        async function loadMusicArrangementModule() {
            try {
                log('🔄 Attempting to load real music-arrangement module through Vite...');
                
                // 通過 Vite 導入 TypeScript 模組
                const { MusicArrangementContainer, MusicArrangementTypes } = await import('/src/modules/music-arrangement/index.ts');
                
                log('📦 Module imported successfully, creating container...');
                
                // 創建 DI 容器並獲取服務
                const container = new MusicArrangementContainer();
                log('🔧 Container created, initializing...');
                
                await container.initialize();
                log('⚙️ Container initialized, getting service...');
                
                musicArrangementService = container.get(MusicArrangementTypes.MusicArrangementService);
                
                isModuleLoaded = true;
                
                document.getElementById('loadingStatus').innerHTML = `
                    <div class="success">
                        ✅ Successfully loaded real Music Arrangement BC!<br>
                        📦 Service: ${musicArrangementService.constructor.name}<br>
                        🎵 Ready for real operations<br>
                        🚀 Running through Vite development server
                    </div>
                `;
                
                log('✅ Real Music Arrangement BC loaded successfully!');
                log('🎵 You can now use real track management, MIDI, and audio features');
                
                // 測試基本功能
                await testBasicFunctionality();
                
            } catch (error) {
                console.error('Failed to load music-arrangement module:', error);
                
                let errorMessage = error.message;
                let suggestions = [];
                
                if (error.message.includes('Failed to fetch')) {
                    suggestions.push('確保你正在通過 Vite 開發伺服器訪問此頁面 (http://localhost:3001)');
                    suggestions.push('執行 `npm run dev` 啟動開發伺服器');
                }
                
                if (error.message.includes('Cannot resolve')) {
                    suggestions.push('檢查 src/modules/music-arrangement/ 目錄是否存在');
                    suggestions.push('確保所有 TypeScript 檔案都存在且沒有語法錯誤');
                }
                
                document.getElementById('loadingStatus').innerHTML = `
                    <div class="error">
                        ❌ Failed to load real Music Arrangement BC<br>
                        📝 Error: ${errorMessage}<br>
                        ${suggestions.length > 0 ? '<br>💡 建議：<br>' + suggestions.map(s => `• ${s}`).join('<br>') : ''}
                    </div>
                `;
                
                log(`❌ Failed to load real module: ${errorMessage}`);
                suggestions.forEach(suggestion => log(`💡 ${suggestion}`));
                
                // 提供備用的模擬實現
                await loadFallbackImplementation();
            }
        }
        
        // 備用模擬實現
        async function loadFallbackImplementation() {
            log('🔄 Loading fallback simulation...');
            
            // 簡化的模擬服務
            musicArrangementService = {
                async createTrack(ownerId, type, name) {
                    const trackId = `sim_track_${Date.now()}`;
                    log(`📝 [SIMULATION] Creating track: ${name} (${type}) for ${ownerId}`);
                    currentTrackId = trackId;
                    return trackId;
                },
                
                async getTrackInfo(trackId) {
                    log(`📋 [SIMULATION] Getting track info for ${trackId}`);
                    return {
                        trackId,
                        name: 'Simulated Track',
                        type: 'audio',
                        ownerId: 'user123',
                        status: 'active',
                        clipCount: 0
                    };
                },
                
                async getSystemStats() {
                    log('📊 [SIMULATION] Getting system stats');
                    return {
                        trackCount: 1,
                        clipCount: 0,
                        isSimulation: true
                    };
                },
                
                async createMidiClip(trackId, timeRange, instrument, name) {
                    log(`🎹 [SIMULATION] Creating MIDI clip ${name} in track ${trackId}`);
                    return `sim_midi_clip_${Date.now()}`;
                },
                
                async addMidiNote(trackId, clipId, pitch, velocity, timeRange) {
                    log(`🎹 [SIMULATION] Adding MIDI note ${pitch} to clip ${clipId} in track ${trackId}`);
                    return `sim_note_${Date.now()}`;
                },
                
                async quantizeMidiClip(trackId, clipId, quantizeValue) {
                    log(`📐 [SIMULATION] Quantizing MIDI clip ${clipId} in track ${trackId}`);
                    return { success: true, simulation: true };
                },
                
                async transposeMidiClip(trackId, clipId, semitones) {
                    log(`🎵 [SIMULATION] Transposing MIDI clip ${clipId} by ${semitones} semitones`);
                    return { success: true, simulation: true };
                },
                
                async createAudioClip(trackId, timeRange, audioSource, name) {
                    log(`🎵 [SIMULATION] Creating audio clip ${name} in track ${trackId}`);
                    return `sim_audio_clip_${Date.now()}`;
                },
                
                async getClipsInTrack(trackId) {
                    log(`📋 [SIMULATION] Getting clips in track ${trackId}`);
                    return [
                        {
                            id: 'sim_clip_1',
                            name: 'Simulated Clip',
                            type: 'midi',
                            startTime: 0,
                            endTime: 4,
                            duration: 4
                        }
                    ];
                }
            };
            
            document.getElementById('loadingStatus').innerHTML += `
                <div class="warning">
                    🔄 Using fallback simulation mode<br>
                    ⚠️ This is not the real Music Arrangement BC<br>
                    💡 Start Vite dev server to use real module
                </div>
            `;
            
            log('🔄 Fallback simulation loaded');
        }
        
        // 測試基本功能
        async function testBasicFunctionality() {
            try {
                log('🧪 Testing basic functionality...');
                
                // 測試系統統計
                const stats = await musicArrangementService.getSystemStats();
                log(`📊 System stats: ${JSON.stringify(stats)}`);
                
                log('✅ Basic functionality test passed!');
                
            } catch (error) {
                log(`❌ Basic functionality test failed: ${error.message}`);
            }
        }
        
        // UI 函數 - 使用真正的服務
        window.createRealTrack = async function() {
            if (!musicArrangementService) {
                log('❌ Music Arrangement Service not loaded');
                return;
            }
            
            const name = document.getElementById('trackName').value;
            const type = document.getElementById('trackType').value;
            const ownerId = document.getElementById('ownerId').value;
            
            try {
                const trackId = await musicArrangementService.createTrack(ownerId, type, name);
                currentTrackId = trackId;
                log(`✅ Track created with ID: ${trackId}`);
                
                // 自動填入軌道 ID 到其他欄位
                document.getElementById('midiTrackId').value = trackId;
                document.getElementById('audioTrackId').value = trackId;
                
                // 更新軌道列表
                updateTrackDisplay(trackId, name, type, ownerId);
                
            } catch (error) {
                log(`❌ Error creating track: ${error.message}`);
            }
        };
        
        window.getTrackInfo = async function() {
            if (!musicArrangementService || !currentTrackId) {
                log('❌ No track available or service not loaded');
                return;
            }
            
            try {
                const trackInfo = await musicArrangementService.getTrackInfo(currentTrackId);
                log(`📋 Track info: ${JSON.stringify(trackInfo, null, 2)}`);
            } catch (error) {
                log(`❌ Error getting track info: ${error.message}`);
            }
        };
        
        window.testRealAudio = async function() {
            if (!musicArrangementService) {
                log('❌ Music Arrangement Service not loaded');
                return;
            }
            
            try {
                // 如果有音頻測試方法
                if (typeof musicArrangementService.playTestSound === 'function') {
                    await musicArrangementService.playTestSound();
                    log('🎵 Playing test sound through real service');
                } else {
                    log('🎵 Audio test method not available in current service');
                    log('💡 Try creating an audio clip and playing it');
                }
            } catch (error) {
                log(`❌ Error testing audio: ${error.message}`);
            }
        };
        
        window.getRealSystemStats = async function() {
            if (!musicArrangementService) {
                log('❌ Music Arrangement Service not loaded');
                return;
            }
            
            try {
                const stats = await musicArrangementService.getSystemStats();
                log(`📊 Real system stats: ${JSON.stringify(stats, null, 2)}`);
            } catch (error) {
                log(`❌ Error getting system stats: ${error.message}`);
            }
        };
        
        window.addMidiNote = async function() {
            if (!musicArrangementService) {
                log('❌ Music Arrangement Service not loaded');
                return;
            }
            
            const trackId = document.getElementById('midiTrackId').value;
            const note = parseInt(document.getElementById('midiNote').value);
            const velocity = parseInt(document.getElementById('midiVelocity').value);
            const startTime = parseFloat(document.getElementById('midiStartTime').value);
            const duration = parseFloat(document.getElementById('midiDuration').value);
            
            if (!trackId) {
                log('❌ Please enter a MIDI track ID or create a track first');
                return;
            }
            
            try {
                // 首先創建一個 MIDI clip（如果還沒有的話）
                log('🎹 Creating MIDI clip first...');
                const clipId = await musicArrangementService.createMidiClip(
                    trackId,
                    { startTime: 0, endTime: 16 }, // 16 秒的 clip
                    { type: 'synth', name: 'Default Synth' },
                    'MIDI Clip 1'
                );
                log(`✅ MIDI clip created: ${clipId}`);
                
                // 然後添加 MIDI 音符
                const endTime = startTime + duration;
                const result = await musicArrangementService.addMidiNote(
                    trackId, 
                    clipId, 
                    note, 
                    velocity, 
                    { startTime, endTime }
                );
                log(`🎹 MIDI note added: ${JSON.stringify(result)}`);
            } catch (error) {
                log(`❌ Error adding MIDI note: ${error.message}`);
            }
        };
        
        window.quantizeMidi = async function() {
            const trackId = document.getElementById('midiTrackId').value;
            
            if (!trackId) {
                log('❌ Please enter a MIDI track ID');
                return;
            }
            
            try {
                // 獲取軌道中的 clips
                const clips = await musicArrangementService.getClipsInTrack(trackId);
                if (clips.length === 0) {
                    log('❌ No clips found in track. Create a MIDI clip first.');
                    return;
                }
                
                const clipId = clips[0].id; // 使用第一個 clip
                const result = await musicArrangementService.quantizeMidiClip(trackId, clipId, '1/16'); // 16th note quantization
                log(`📐 MIDI quantized: ${JSON.stringify(result)}`);
            } catch (error) {
                log(`❌ Error quantizing MIDI: ${error.message}`);
            }
        };
        
        window.transposeMidi = async function() {
            const trackId = document.getElementById('midiTrackId').value;
            
            if (!trackId) {
                log('❌ Please enter a MIDI track ID');
                return;
            }
            
            try {
                // 獲取軌道中的 clips
                const clips = await musicArrangementService.getClipsInTrack(trackId);
                if (clips.length === 0) {
                    log('❌ No clips found in track. Create a MIDI clip first.');
                    return;
                }
                
                const clipId = clips[0].id; // 使用第一個 clip
                const result = await musicArrangementService.transposeMidiClip(trackId, clipId, 2); // Transpose up 2 semitones
                log(`🎵 MIDI transposed: ${JSON.stringify(result)}`);
            } catch (error) {
                log(`❌ Error transposing MIDI: ${error.message}`);
            }
        };
        
        window.createAudioClip = async function() {
            if (!musicArrangementService) {
                log('❌ Music Arrangement Service not loaded');
                return;
            }
            
            const trackId = document.getElementById('audioTrackId').value;
            const audioUrl = document.getElementById('audioUrl').value;
            const startTime = parseFloat(document.getElementById('audioStartTime').value);
            const duration = parseFloat(document.getElementById('audioDuration').value);
            
            if (!trackId) {
                log('❌ Please enter an audio track ID or create a track first');
                return;
            }
            
            try {
                const endTime = startTime + duration;
                const result = await musicArrangementService.createAudioClip(
                    trackId,
                    { startTime, endTime },
                    { url: audioUrl, name: 'Audio Sample' },
                    'Audio Clip 1'
                );
                log(`🎵 Audio clip created: ${JSON.stringify(result)}`);
            } catch (error) {
                log(`❌ Error creating audio clip: ${error.message}`);
            }
        };
        
        window.getClipsInTrack = async function() {
            const trackId = document.getElementById('midiTrackId').value || document.getElementById('audioTrackId').value;
            
            if (!trackId) {
                log('❌ Please enter a track ID');
                return;
            }
            
            try {
                const clips = await musicArrangementService.getClipsInTrack(trackId);
                log(`📋 Track clips: ${JSON.stringify(clips, null, 2)}`);
            } catch (error) {
                log(`❌ Error getting track clips: ${error.message}`);
            }
        };
        
        window.setAudioClipGain = async function() {
            const trackId = document.getElementById('audioTrackId').value;
            
            if (!trackId) {
                log('❌ Please enter an audio track ID');
                return;
            }
            
            try {
                // 假設有音頻片段，設定增益為 0.8
                const result = await musicArrangementService.setAudioClipGain(trackId, 'clip_1', 0.8);
                log(`🎛️ Audio clip gain set: ${JSON.stringify(result)}`);
            } catch (error) {
                log(`❌ Error setting audio clip gain: ${error.message}`);
            }
        };
        
        window.clearLog = function() {
            document.getElementById('status').innerHTML = '<div>🎵 Log cleared</div>';
        };
        
        // 更新軌道顯示
        function updateTrackDisplay(trackId, name, type, ownerId) {
            const trackListDiv = document.getElementById('realTrackList');
            
            trackListDiv.innerHTML = `
                <div class="track-card">
                    <div class="track-header">
                        <strong>${name}</strong>
                        <span class="track-controls">
                            <button class="small-button" onclick="selectTrack('${trackId}')">選擇</button>
                        </span>
                    </div>
                    <div>ID: ${trackId}</div>
                    <div>Type: ${type}</div>
                    <div>Owner: ${ownerId}</div>
                    <div>Status: active</div>
                </div>
            `;
        }
        
        window.selectTrack = function(trackId) {
            document.getElementById('midiTrackId').value = trackId;
            document.getElementById('audioTrackId').value = trackId;
            currentTrackId = trackId;
            log(`✅ Selected track: ${trackId}`);
        };
        
        // 日誌函數
        function log(message) {
            const statusDiv = document.getElementById('status');
            const time = new Date().toLocaleTimeString();
            statusDiv.innerHTML += `<div>[${time}] ${message}</div>`;
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }
        
        // 檢查是否在 Vite 開發環境中
        function checkViteEnvironment() {
            const isVite = window.location.protocol === 'http:' && 
                          (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1');
            
            if (!isVite) {
                document.getElementById('loadingStatus').innerHTML = `
                    <div class="warning">
                        ⚠️ 不在 Vite 開發環境中<br>
                        💡 請執行 \`npm run dev\` 並通過 http://localhost:3001 訪問此頁面
                    </div>
                `;
                log('⚠️ Not running in Vite development environment');
                log('💡 Please run `npm run dev` and access via http://localhost:3001');
                return false;
            }
            
            return true;
        }
        
        // 初始化
        log('🎵 Starting Real Music Arrangement BC Test (Vite)...');
        
        if (checkViteEnvironment()) {
            loadMusicArrangementModule();
        } else {
            setTimeout(loadFallbackImplementation, 1000);
        }
    </script>
</body>
</html> 