<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎵 MVP Audio Engine Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .synth-button {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }
        
        .control-button {
            background: linear-gradient(45deg, #a8edea, #fed6e3);
            color: #333;
        }
        
        .piano {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
            gap: 2px;
        }
        
        .key {
            width: 40px;
            height: 120px;
            border: 1px solid #ccc;
            cursor: pointer;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.1s ease;
        }
        
        .white-key {
            background: white;
            color: #333;
        }
        
        .black-key {
            background: #333;
            color: white;
            height: 80px;
            width: 25px;
            margin: 0 -12.5px;
            z-index: 1;
        }
        
        .key:hover {
            transform: scale(1.05);
        }
        
        .key:active {
            transform: scale(0.95);
        }
        
        .controls {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 30px 0;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        input[type="range"] {
            width: 150px;
            height: 5px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
        }
        
        .status {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .emoji {
            font-size: 1.2em;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎵 MVP Audio Engine Test</h1>
        
        <div class="button-grid">
            <button onclick="playTestSound()">
                <span class="emoji">🎵</span>測試音效
            </button>
            <button onclick="playMelody()">
                <span class="emoji">🎶</span>播放旋律
            </button>
            <button onclick="startMetronome()" class="synth-button">
                <span class="emoji">🥁</span>節拍器
            </button>
            <button onclick="stopMetronome()" class="control-button">
                <span class="emoji">⏹️</span>停止節拍器
            </button>
        </div>
        
        <div class="piano">
            <div class="key white-key" onclick="playNote('C4')" data-note="C4">C</div>
            <div class="key black-key" onclick="playNote('C#4')" data-note="C#4">C#</div>
            <div class="key white-key" onclick="playNote('D4')" data-note="D4">D</div>
            <div class="key black-key" onclick="playNote('D#4')" data-note="D#4">D#</div>
            <div class="key white-key" onclick="playNote('E4')" data-note="E4">E</div>
            <div class="key white-key" onclick="playNote('F4')" data-note="F4">F</div>
            <div class="key black-key" onclick="playNote('F#4')" data-note="F#4">F#</div>
            <div class="key white-key" onclick="playNote('G4')" data-note="G4">G</div>
            <div class="key black-key" onclick="playNote('G#4')" data-note="G#4">G#</div>
            <div class="key white-key" onclick="playNote('A4')" data-note="A4">A</div>
            <div class="key black-key" onclick="playNote('A#4')" data-note="A#4">A#</div>
            <div class="key white-key" onclick="playNote('B4')" data-note="B4">B</div>
            <div class="key white-key" onclick="playNote('C5')" data-note="C5">C5</div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>🎛️ 主音量</label>
                <input type="range" id="masterVolume" min="0" max="1" step="0.1" value="0.8" 
                       onchange="setMasterVolume(this.value)">
                <span id="volumeValue">0.8</span>
            </div>
            
            <div class="control-group">
                <label>🎵 BPM</label>
                <input type="range" id="bpm" min="60" max="200" step="10" value="120" 
                       onchange="setBpm(this.value)">
                <span id="bpmValue">120</span>
            </div>
        </div>
        
        <div class="button-grid">
            <button onclick="showStatus()" class="control-button">
                <span class="emoji">📊</span>顯示狀態
            </button>
            <button onclick="clearLog()" class="control-button">
                <span class="emoji">🧹</span>清除日誌
            </button>
        </div>
        
        <div class="status" id="status">
            <div>🎵 Audio Engine Ready! 點擊按鈕開始測試...</div>
        </div>
    </div>

    <script>
        // 🎵 SimpleMVPAudioEngine 實現
        class SimpleMVPAudioEngine {
            constructor() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.masterGain = this.audioContext.createGain();
                this.masterGain.connect(this.audioContext.destination);
                this.masterGain.gain.value = 0.8;
                this.tracks = new Map();
                this.isPlaying = false;
                this.bpm = 120;
                
                this.log('🎵 SimpleMVPAudioEngine initialized - Ready to make sound!');
            }
            
            async ensureAudioContext() {
                if (this.audioContext.state === 'suspended') {
                    await this.audioContext.resume();
                    this.log('🎵 Audio context resumed');
                }
            }
            
            async playNote(frequency, duration = 1, trackId = 'synth') {
                try {
                    await this.ensureAudioContext();
                    
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.masterGain);
                    
                    oscillator.frequency.value = frequency;
                    oscillator.type = 'sawtooth';
                    
                    const now = this.audioContext.currentTime;
                    gainNode.gain.setValueAtTime(0, now);
                    gainNode.gain.linearRampToValueAtTime(0.3, now + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.1, now + 0.1);
                    gainNode.gain.setValueAtTime(0.1, now + 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);
                    
                    oscillator.start(now);
                    oscillator.stop(now + duration);
                    
                    this.log(`🎹 Playing note: ${frequency}Hz for ${duration}s`);
                    
                } catch (error) {
                    this.log(`❌ Failed to play note: ${error.message}`);
                }
            }
            
            playNoteByName(noteName, duration = 1, trackId = 'synth') {
                const frequency = this.noteToFrequency(noteName);
                this.playNote(frequency, duration, trackId);
            }
            
            playChord(frequencies, duration = 2, trackId = 'chord') {
                frequencies.forEach((freq, index) => {
                    setTimeout(() => {
                        this.playNote(freq, duration, `${trackId}_${index}`);
                    }, index * 50);
                });
            }
            
            playTestSound() {
                this.log('🎵 Playing test sound - C Major Chord');
                const chord = [261.63, 329.63, 392.00, 523.25]; // C-E-G-C
                this.playChord(chord, 3, 'test');
            }
            
            playMelody() {
                this.log('🎵 Playing melody - Twinkle Twinkle Little Star');
                const melody = [
                    { note: 'C4', duration: 0.5 },
                    { note: 'C4', duration: 0.5 },
                    { note: 'G4', duration: 0.5 },
                    { note: 'G4', duration: 0.5 },
                    { note: 'A4', duration: 0.5 },
                    { note: 'A4', duration: 0.5 },
                    { note: 'G4', duration: 1.0 }
                ];
                
                let currentTime = 0;
                melody.forEach(({ note, duration }) => {
                    setTimeout(() => {
                        this.playNoteByName(note, duration, 'melody');
                    }, currentTime * 1000);
                    currentTime += duration;
                });
            }
            
            setMasterVolume(volume) {
                const clampedVolume = Math.max(0, Math.min(1, volume));
                this.masterGain.gain.value = clampedVolume;
                this.log(`🎛️ Master volume set to ${clampedVolume}`);
            }
            
            setBpm(bpm) {
                this.bpm = Math.max(60, Math.min(200, bpm));
                this.log(`🎛️ BPM set to ${this.bpm}`);
            }
            
            startMetronome() {
                if (this.isPlaying) return;
                
                this.isPlaying = true;
                const interval = 60000 / this.bpm;
                
                const tick = () => {
                    if (!this.isPlaying) return;
                    this.playNote(800, 0.1, 'metronome');
                    setTimeout(tick, interval);
                };
                
                tick();
                this.log(`🎵 Metronome started at ${this.bpm} BPM`);
            }
            
            stopMetronome() {
                this.isPlaying = false;
                this.log('🎵 Metronome stopped');
            }
            
            getStatus() {
                return {
                    isPlaying: this.isPlaying,
                    bpm: this.bpm,
                    trackCount: this.tracks.size,
                    masterVolume: this.masterGain.gain.value,
                    audioContextState: this.audioContext.state
                };
            }
            
            noteToFrequency(noteName) {
                const noteMap = {
                    'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13,
                    'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00,
                    'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
                    'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25,
                    'E5': 659.25, 'F5': 698.46, 'F#5': 739.99, 'G5': 783.99
                };
                return noteMap[noteName] || 440;
            }
            
            log(message) {
                const statusDiv = document.getElementById('status');
                const time = new Date().toLocaleTimeString();
                statusDiv.innerHTML += `<div>[${time}] ${message}</div>`;
                statusDiv.scrollTop = statusDiv.scrollHeight;
            }
        }
        
        // 創建全域音頻引擎實例
        const audioEngine = new SimpleMVPAudioEngine();
        
        // UI 控制函數
        function playTestSound() {
            audioEngine.playTestSound();
        }
        
        function playMelody() {
            audioEngine.playMelody();
        }
        
        function playNote(noteName) {
            audioEngine.playNoteByName(noteName, 0.5);
        }
        
        function setMasterVolume(volume) {
            audioEngine.setMasterVolume(parseFloat(volume));
            document.getElementById('volumeValue').textContent = volume;
        }
        
        function setBpm(bpm) {
            audioEngine.setBpm(parseInt(bpm));
            document.getElementById('bpmValue').textContent = bpm;
        }
        
        function startMetronome() {
            audioEngine.startMetronome();
        }
        
        function stopMetronome() {
            audioEngine.stopMetronome();
        }
        
        function showStatus() {
            const status = audioEngine.getStatus();
            audioEngine.log(`📊 Status: ${JSON.stringify(status, null, 2)}`);
        }
        
        function clearLog() {
            document.getElementById('status').innerHTML = '<div>🎵 Log cleared</div>';
        }
        
        // 鍵盤快捷鍵
        document.addEventListener('keydown', (event) => {
            const keyMap = {
                'a': 'C4', 'w': 'C#4', 's': 'D4', 'e': 'D#4', 'd': 'E4',
                'f': 'F4', 't': 'F#4', 'g': 'G4', 'y': 'G#4', 'h': 'A4',
                'u': 'A#4', 'j': 'B4', 'k': 'C5'
            };
            
            if (keyMap[event.key.toLowerCase()]) {
                playNote(keyMap[event.key.toLowerCase()]);
                event.preventDefault();
            }
        });
        
        // 初始化提示
        audioEngine.log('🎹 使用鍵盤快捷鍵: A-S-D-F-G-H-J-K 對應白鍵，W-E-T-Y-U 對應黑鍵');
        audioEngine.log('🎵 點擊按鈕或鋼琴鍵開始測試音頻功能！');
    </script>
</body>
</html> 