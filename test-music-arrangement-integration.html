<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎵 Music Arrangement BC Integration Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section h2 {
            margin-top: 0;
            color: #ffd700;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            padding-bottom: 10px;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .track-button {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }
        
        .collaboration-button {
            background: linear-gradient(45deg, #a8edea, #fed6e3);
            color: #333;
        }
        
        .audio-button {
            background: linear-gradient(45deg, #ffeaa7, #fab1a0);
            color: #333;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        input, select {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        
        .status {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .track-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .track-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .track-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .track-controls {
            display: flex;
            gap: 5px;
        }
        
        .small-button {
            padding: 5px 10px;
            font-size: 12px;
            min-width: auto;
        }
        
        .collaboration-panel {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .collaborator-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .collaborator-tag {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .emoji {
            font-size: 1.2em;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎵 Music Arrangement BC Integration Test</h1>
        
        <!-- Track Management Section -->
        <div class="section">
            <h2>🎛️ Track Management</h2>
            
            <div class="input-group">
                <input type="text" id="trackName" placeholder="軌道名稱" value="My Track">
                <select id="trackType">
                    <option value="audio">Audio Track</option>
                    <option value="midi">MIDI Track</option>
                </select>
                <input type="text" id="ownerId" placeholder="擁有者 ID" value="user123">
            </div>
            
            <div class="button-grid">
                <button onclick="createTrack()" class="track-button">
                    <span class="emoji">➕</span>創建軌道
                </button>
                <button onclick="getAllTracks()" class="track-button">
                    <span class="emoji">📋</span>獲取所有軌道
                </button>
                <button onclick="playTestAudio()" class="audio-button">
                    <span class="emoji">🎵</span>播放測試音效
                </button>
                <button onclick="getSystemStats()" class="track-button">
                    <span class="emoji">📊</span>系統統計
                </button>
            </div>
            
            <div class="track-list" id="trackList">
                <!-- 軌道列表將在這裡顯示 -->
            </div>
        </div>
        
        <!-- Collaboration Section -->
        <div class="section">
            <h2>🤝 Collaboration Features</h2>
            
            <div class="input-group">
                <input type="text" id="collaboratorId" placeholder="協作者 ID" value="user456">
                <select id="permissions">
                    <option value="read">Read Only</option>
                    <option value="write">Read & Write</option>
                    <option value="admin">Admin</option>
                </select>
                <input type="text" id="targetTrackId" placeholder="軌道 ID">
            </div>
            
            <div class="button-grid">
                <button onclick="shareTrack()" class="collaboration-button">
                    <span class="emoji">🤝</span>分享軌道
                </button>
                <button onclick="joinSession()" class="collaboration-button">
                    <span class="emoji">🚪</span>加入協作
                </button>
                <button onclick="getCollaborators()" class="collaboration-button">
                    <span class="emoji">👥</span>查看協作者
                </button>
                <button onclick="simulateCollaboration()" class="collaboration-button">
                    <span class="emoji">🎭</span>模擬協作
                </button>
            </div>
            
            <div class="collaboration-panel" id="collaborationPanel">
                <h3>🤝 協作狀態</h3>
                <div id="collaboratorList" class="collaborator-list">
                    <!-- 協作者列表將在這裡顯示 -->
                </div>
            </div>
        </div>
        
        <!-- Audio Engine Section -->
        <div class="section">
            <h2>🎵 Audio Engine Integration</h2>
            
            <div class="input-group">
                <select id="noteSelect">
                    <option value="C4">C4</option>
                    <option value="D4">D4</option>
                    <option value="E4">E4</option>
                    <option value="F4">F4</option>
                    <option value="G4">G4</option>
                    <option value="A4">A4</option>
                    <option value="B4">B4</option>
                </select>
                <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.8">
                <span id="volumeDisplay">0.8</span>
            </div>
            
            <div class="button-grid">
                <button onclick="playNote()" class="audio-button">
                    <span class="emoji">🎹</span>播放音符
                </button>
                <button onclick="playMelody()" class="audio-button">
                    <span class="emoji">🎶</span>播放旋律
                </button>
                <button onclick="startMetronome()" class="audio-button">
                    <span class="emoji">🥁</span>節拍器
                </button>
                <button onclick="stopMetronome()" class="audio-button">
                    <span class="emoji">⏹️</span>停止
                </button>
            </div>
        </div>
        
        <!-- System Status -->
        <div class="section">
            <h2>📊 System Status</h2>
            <button onclick="clearLog()" class="collaboration-button">
                <span class="emoji">🧹</span>清除日誌
            </button>
            <div class="status" id="status">
                <div>🎵 Music Arrangement BC Ready! 開始測試...</div>
            </div>
        </div>
    </div>

    <script type="module">
        // 🎵 模擬 Music Arrangement BC 的完整實現
        
        // ===== Domain Layer Simulation =====
        class TrackId {
            constructor(value) {
                this.value = value;
            }
            
            toString() {
                return this.value;
            }
        }
        
        class PeerId {
            constructor(value) {
                this.value = value;
            }
            
            toString() {
                return this.value;
            }
        }
        
        // ===== Audio Engine =====
        class SimpleMVPAudioEngine {
            constructor() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.masterGain = this.audioContext.createGain();
                this.masterGain.connect(this.audioContext.destination);
                this.masterGain.gain.value = 0.8;
                this.isPlaying = false;
                this.bpm = 120;
            }
            
            async ensureAudioContext() {
                if (this.audioContext.state === 'suspended') {
                    await this.audioContext.resume();
                }
            }
            
            async playNote(frequency, duration = 1) {
                await this.ensureAudioContext();
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.masterGain);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sawtooth';
                
                const now = this.audioContext.currentTime;
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.3, now + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);
                
                oscillator.start(now);
                oscillator.stop(now + duration);
            }
            
            playNoteByName(noteName, duration = 1) {
                const noteMap = {
                    'C4': 261.63, 'D4': 293.66, 'E4': 329.63, 'F4': 349.23,
                    'G4': 392.00, 'A4': 440.00, 'B4': 493.88
                };
                const frequency = noteMap[noteName] || 440;
                this.playNote(frequency, duration);
            }
            
            playTestSound() {
                const chord = [261.63, 329.63, 392.00, 523.25];
                chord.forEach((freq, index) => {
                    setTimeout(() => this.playNote(freq, 2), index * 100);
                });
            }
            
            playMelody() {
                const melody = [
                    { note: 'C4', duration: 0.5 },
                    { note: 'D4', duration: 0.5 },
                    { note: 'E4', duration: 0.5 },
                    { note: 'F4', duration: 0.5 },
                    { note: 'G4', duration: 1.0 }
                ];
                
                let currentTime = 0;
                melody.forEach(({ note, duration }) => {
                    setTimeout(() => {
                        this.playNoteByName(note, duration);
                    }, currentTime * 1000);
                    currentTime += duration;
                });
            }
            
            setMasterVolume(volume) {
                this.masterGain.gain.value = Math.max(0, Math.min(1, volume));
            }
            
            startMetronome() {
                if (this.isPlaying) return;
                this.isPlaying = true;
                const interval = 60000 / this.bpm;
                
                const tick = () => {
                    if (!this.isPlaying) return;
                    this.playNote(800, 0.1);
                    setTimeout(tick, interval);
                };
                tick();
            }
            
            stopMetronome() {
                this.isPlaying = false;
            }
        }
        
        // ===== Music Arrangement Service Simulation =====
        class MusicArrangementService {
            constructor() {
                this.audioEngine = new SimpleMVPAudioEngine();
                this.tracks = new Map();
                this.collaborationSessions = new Map();
                this.trackCounter = 1;
                
                this.log('🎵 MusicArrangementService initialized with audio engine');
            }
            
            // Track Management
            async createTrack(name, type, ownerId) {
                const trackId = `track_${this.trackCounter++}`;
                const track = {
                    id: trackId,
                    name: name,
                    type: type,
                    ownerId: ownerId,
                    status: 'active',
                    createdAt: new Date(),
                    clips: [],
                    collaborators: []
                };
                
                this.tracks.set(trackId, track);
                this.log(`✅ Track created: ${name} (${trackId}) by ${ownerId}`);
                
                return {
                    trackId: trackId,
                    name: name,
                    type: type,
                    ownerId: ownerId,
                    status: 'active'
                };
            }
            
            async getTrackInfo(trackId) {
                const track = this.tracks.get(trackId);
                if (!track) {
                    throw new Error(`Track not found: ${trackId}`);
                }
                
                return {
                    trackId: track.id,
                    name: track.name,
                    type: track.type,
                    ownerId: track.ownerId,
                    status: track.status,
                    clipCount: track.clips.length,
                    collaboratorCount: track.collaborators.length
                };
            }
            
            async getAllTracks() {
                const trackList = Array.from(this.tracks.values()).map(track => ({
                    trackId: track.id,
                    name: track.name,
                    type: track.type,
                    ownerId: track.ownerId,
                    status: track.status,
                    clipCount: track.clips.length,
                    collaboratorCount: track.collaborators.length
                }));
                
                this.log(`📋 Retrieved ${trackList.length} tracks`);
                return trackList;
            }
            
            async getSystemStats() {
                const stats = {
                    trackCount: this.tracks.size,
                    clipCount: Array.from(this.tracks.values()).reduce((sum, track) => sum + track.clips.length, 0),
                    collaborationCount: this.collaborationSessions.size,
                    audioEngineStatus: this.audioEngine.audioContext.state
                };
                
                this.log(`📊 System stats: ${JSON.stringify(stats)}`);
                return stats;
            }
            
            // Collaboration Features
            async shareTrack(trackId, collaboratorId, permissions, sharedBy) {
                const track = this.tracks.get(trackId);
                if (!track) {
                    throw new Error(`Track not found: ${trackId}`);
                }
                
                const collaborator = {
                    peerId: collaboratorId,
                    permissions: Array.isArray(permissions) ? permissions : [permissions],
                    joinedAt: new Date(),
                    isOnline: true
                };
                
                track.collaborators.push(collaborator);
                
                // Create or update collaboration session
                if (!this.collaborationSessions.has(trackId)) {
                    this.collaborationSessions.set(trackId, {
                        sessionId: `session_${trackId}`,
                        trackId: trackId,
                        ownerId: track.ownerId,
                        collaborators: [],
                        isActive: true,
                        createdAt: new Date()
                    });
                }
                
                const session = this.collaborationSessions.get(trackId);
                session.collaborators.push(collaborator);
                
                this.log(`🤝 Track ${trackId} shared with ${collaboratorId} (${permissions})`);
            }
            
            async joinCollaborationSession(trackId, collaboratorId) {
                const session = this.collaborationSessions.get(trackId);
                if (!session) {
                    throw new Error(`No collaboration session for track: ${trackId}`);
                }
                
                this.log(`🚪 ${collaboratorId} joined collaboration session for track ${trackId}`);
                
                // Simulate real-time notification
                setTimeout(() => {
                    this.log(`📢 Notified other collaborators: ${collaboratorId} joined`);
                }, 100);
            }
            
            async getTrackCollaborators(trackId) {
                const session = this.collaborationSessions.get(trackId);
                if (!session) {
                    return [];
                }
                
                return session.collaborators.map(c => ({
                    peerId: c.peerId,
                    permissions: c.permissions,
                    isOnline: c.isOnline,
                    joinedAt: c.joinedAt.toISOString()
                }));
            }
            
            async recordCollaborativeOperation(trackId, operation, performedBy) {
                this.log(`🎭 Collaborative operation: ${operation.type} on track ${trackId} by ${performedBy}`);
                
                // Simulate broadcasting to other collaborators
                const collaborators = await this.getTrackCollaborators(trackId);
                collaborators.forEach(collaborator => {
                    if (collaborator.peerId !== performedBy) {
                        setTimeout(() => {
                            this.log(`📡 Broadcasted to ${collaborator.peerId}: ${operation.type}`);
                        }, 50);
                    }
                });
            }
            
            // Audio Integration
            async playTestSound() {
                this.log('🎵 Playing test sound through MusicArrangementService');
                this.audioEngine.playTestSound();
            }
            
            async playNote(note, duration = 1) {
                this.log(`🎹 Playing note: ${note} for ${duration}s`);
                this.audioEngine.playNoteByName(note, duration);
            }
            
            async playMelody() {
                this.log('🎶 Playing melody through MusicArrangementService');
                this.audioEngine.playMelody();
            }
            
            async setMasterVolume(volume) {
                this.log(`🎛️ Setting master volume to ${volume}`);
                this.audioEngine.setMasterVolume(volume);
            }
            
            async startMetronome() {
                this.log('🥁 Starting metronome');
                this.audioEngine.startMetronome();
            }
            
            async stopMetronome() {
                this.log('⏹️ Stopping metronome');
                this.audioEngine.stopMetronome();
            }
            
            // Utility
            log(message) {
                const statusDiv = document.getElementById('status');
                const time = new Date().toLocaleTimeString();
                statusDiv.innerHTML += `<div>[${time}] ${message}</div>`;
                statusDiv.scrollTop = statusDiv.scrollHeight;
            }
        }
        
        // ===== Global Service Instance =====
        const musicArrangementService = new MusicArrangementService();
        
        // ===== UI Functions =====
        window.createTrack = async function() {
            const name = document.getElementById('trackName').value;
            const type = document.getElementById('trackType').value;
            const ownerId = document.getElementById('ownerId').value;
            
            try {
                const result = await musicArrangementService.createTrack(name, type, ownerId);
                updateTrackList();
            } catch (error) {
                musicArrangementService.log(`❌ Error creating track: ${error.message}`);
            }
        };
        
        window.getAllTracks = async function() {
            try {
                const tracks = await musicArrangementService.getAllTracks();
                updateTrackList();
            } catch (error) {
                musicArrangementService.log(`❌ Error getting tracks: ${error.message}`);
            }
        };
        
        window.getSystemStats = async function() {
            try {
                const stats = await musicArrangementService.getSystemStats();
            } catch (error) {
                musicArrangementService.log(`❌ Error getting stats: ${error.message}`);
            }
        };
        
        window.shareTrack = async function() {
            const collaboratorId = document.getElementById('collaboratorId').value;
            const permissions = document.getElementById('permissions').value;
            const trackId = document.getElementById('targetTrackId').value;
            const sharedBy = document.getElementById('ownerId').value;
            
            if (!trackId) {
                musicArrangementService.log('❌ Please enter a track ID');
                return;
            }
            
            try {
                await musicArrangementService.shareTrack(trackId, collaboratorId, permissions, sharedBy);
                updateCollaboratorList(trackId);
            } catch (error) {
                musicArrangementService.log(`❌ Error sharing track: ${error.message}`);
            }
        };
        
        window.joinSession = async function() {
            const collaboratorId = document.getElementById('collaboratorId').value;
            const trackId = document.getElementById('targetTrackId').value;
            
            if (!trackId) {
                musicArrangementService.log('❌ Please enter a track ID');
                return;
            }
            
            try {
                await musicArrangementService.joinCollaborationSession(trackId, collaboratorId);
            } catch (error) {
                musicArrangementService.log(`❌ Error joining session: ${error.message}`);
            }
        };
        
        window.getCollaborators = async function() {
            const trackId = document.getElementById('targetTrackId').value;
            
            if (!trackId) {
                musicArrangementService.log('❌ Please enter a track ID');
                return;
            }
            
            try {
                const collaborators = await musicArrangementService.getTrackCollaborators(trackId);
                updateCollaboratorList(trackId);
            } catch (error) {
                musicArrangementService.log(`❌ Error getting collaborators: ${error.message}`);
            }
        };
        
        window.simulateCollaboration = async function() {
            const trackId = document.getElementById('targetTrackId').value;
            
            if (!trackId) {
                musicArrangementService.log('❌ Please enter a track ID');
                return;
            }
            
            try {
                // Simulate collaborative operations
                await musicArrangementService.recordCollaborativeOperation(
                    trackId,
                    { id: 'op1', type: 'addClip', data: { clipType: 'audio' } },
                    'user456'
                );
                
                setTimeout(async () => {
                    await musicArrangementService.recordCollaborativeOperation(
                        trackId,
                        { id: 'op2', type: 'adjustVolume', data: { volume: 0.8 } },
                        'user789'
                    );
                }, 1000);
                
            } catch (error) {
                musicArrangementService.log(`❌ Error simulating collaboration: ${error.message}`);
            }
        };
        
        // Audio functions
        window.playTestAudio = async function() {
            await musicArrangementService.playTestSound();
        };
        
        window.playNote = async function() {
            const note = document.getElementById('noteSelect').value;
            await musicArrangementService.playNote(note, 1);
        };
        
        window.playMelody = async function() {
            await musicArrangementService.playMelody();
        };
        
        window.startMetronome = async function() {
            await musicArrangementService.startMetronome();
        };
        
        window.stopMetronome = async function() {
            await musicArrangementService.stopMetronome();
        };
        
        window.clearLog = function() {
            document.getElementById('status').innerHTML = '<div>🎵 Log cleared</div>';
        };
        
        // UI Update functions
        async function updateTrackList() {
            const tracks = await musicArrangementService.getAllTracks();
            const trackListDiv = document.getElementById('trackList');
            
            trackListDiv.innerHTML = tracks.map(track => `
                <div class="track-card">
                    <div class="track-header">
                        <strong>${track.name}</strong>
                        <span class="track-controls">
                            <button class="small-button" onclick="selectTrack('${track.trackId}')">選擇</button>
                            <button class="small-button audio-button" onclick="playTrackNote('${track.trackId}')">🎵</button>
                        </span>
                    </div>
                    <div>ID: ${track.trackId}</div>
                    <div>Type: ${track.type}</div>
                    <div>Owner: ${track.ownerId}</div>
                    <div>Clips: ${track.clipCount} | Collaborators: ${track.collaboratorCount}</div>
                </div>
            `).join('');
        }
        
        async function updateCollaboratorList(trackId) {
            const collaborators = await musicArrangementService.getTrackCollaborators(trackId);
            const collaboratorListDiv = document.getElementById('collaboratorList');
            
            collaboratorListDiv.innerHTML = collaborators.map(c => `
                <div class="collaborator-tag">
                    ${c.peerId} (${c.permissions.join(', ')}) ${c.isOnline ? '🟢' : '🔴'}
                </div>
            `).join('');
        }
        
        window.selectTrack = function(trackId) {
            document.getElementById('targetTrackId').value = trackId;
            musicArrangementService.log(`✅ Selected track: ${trackId}`);
        };
        
        window.playTrackNote = async function(trackId) {
            musicArrangementService.log(`🎵 Playing note for track: ${trackId}`);
            await musicArrangementService.playNote('C4', 0.5);
        };
        
        // Volume control
        document.getElementById('volumeSlider').addEventListener('input', async function(e) {
            const volume = parseFloat(e.target.value);
            document.getElementById('volumeDisplay').textContent = volume;
            await musicArrangementService.setMasterVolume(volume);
        });
        
        // Initialize
        musicArrangementService.log('🎵 Music Arrangement BC Integration Test Ready!');
        musicArrangementService.log('📝 Try creating tracks, sharing them, and testing collaboration features');
    </script>
</body>
</html> 